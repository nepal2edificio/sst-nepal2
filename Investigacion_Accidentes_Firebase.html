<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigaci√≥n de Accidentes - Nepal 2</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-section {
            padding: 40px;
        }
        
        .section-title {
            color: #c2185b;
            font-size: 1.6em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #c2185b;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #c2185b;
            font-size: 1.05em;
        }
        
        .required {
            color: #e91e63;
        }
        
        input, select, textarea {
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #e91e63;
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .alert-box h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }
        
        .severity-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .severity-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .severity-option:hover {
            border-color: #e91e63;
            transform: translateY(-2px);
        }
        
        .severity-option.selected {
            border-color: #c2185b;
            background: #fce4ec;
        }
        
        .severity-option.leve { border-left: 4px solid #4caf50; }
        .severity-option.grave { border-left: 4px solid #ff9800; }
        .severity-option.fatal { border-left: 4px solid #f44336; }
        
        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(194, 24, 91, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .accidentes-list {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .accidente-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #c2185b;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .accidente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .accidente-fecha {
            font-weight: 700;
            color: #c2185b;
            font-size: 1.2em;
        }
        
        .severity-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .severity-badge.leve {
            background: #d4edda;
            color: #155724;
        }
        
        .severity-badge.grave {
            background: #fff3cd;
            color: #856404;
        }
        
        .severity-badge.fatal {
            background: #f8d7da;
            color: #721c24;
        }
        
        .accidente-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-item strong {
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .accidente-descripcion {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .no-accidentes {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-accidentes .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 3em;
            font-weight: 700;
            color: #c2185b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Investigaci√≥n de Accidentes e Incidentes</h1>
            <p>Edificio Nepal 2 - Registro y Seguimiento</p>
        </div>
        
        <div class="form-section">
            <div class="alert-box">
                <h4>‚ö†Ô∏è Importante</h4>
                <p>Todo accidente o incidente debe ser reportado inmediatamente. Complete este formulario lo antes posible despu√©s del evento para garantizar la precisi√≥n de la informaci√≥n.</p>
            </div>
            
            <h2 class="section-title">üìã Informaci√≥n del Evento</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Fecha del Accidente <span class="required">*</span></label>
                    <input type="date" id="fechaAccidente" required>
                </div>
                
                <div class="form-group">
                    <label>Hora del Accidente <span class="required">*</span></label>
                    <input type="time" id="horaAccidente" required>
                </div>
                
                <div class="form-group">
                    <label>Lugar Exacto <span class="required">*</span></label>
                    <select id="lugar" required>
                        <option value="">Seleccionar...</option>
                        <option value="Porter√≠a">Porter√≠a</option>
                        <option value="Lobby Principal">Lobby Principal</option>
                        <option value="Escaleras">Escaleras</option>
                        <option value="Ascensor">Ascensor</option>
                        <option value="Parqueadero">Parqueadero</option>
                        <option value="Cuarto de Basuras">Cuarto de Basuras</option>
                        <option value="Terraza">Terraza</option>
                        <option value="Zonas Comunes">Zonas Comunes</option>
                        <option value="Apartamento">Apartamento</option>
                        <option value="Otro">Otro (especificar en descripci√≥n)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Evento <span class="required">*</span></label>
                    <select id="tipoEvento" required>
                        <option value="">Seleccionar...</option>
                        <option value="Accidente de Trabajo">Accidente de Trabajo</option>
                        <option value="Incidente (sin lesi√≥n)">Incidente (sin lesi√≥n)</option>
                        <option value="Accidente Residente">Accidente de Residente</option>
                        <option value="Accidente Contratista">Accidente de Contratista</option>
                        <option value="Accidente Visitante">Accidente de Visitante</option>
                    </select>
                </div>
            </div>
            
            <h2 class="section-title">üë§ Persona Afectada</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre Completo <span class="required">*</span></label>
                    <input type="text" id="nombreAfectado" required>
                </div>
                
                <div class="form-group">
                    <label>Documento de Identidad</label>
                    <input type="text" id="documentoAfectado">
                </div>
                
                <div class="form-group">
                    <label>Cargo/Rol <span class="required">*</span></label>
                    <select id="cargoAfectado" required>
                        <option value="">Seleccionar...</option>
                        <option value="Trabajador SST">Trabajador (Conserje/Todero)</option>
                        <option value="Residente">Residente</option>
                        <option value="Visitante">Visitante</option>
                        <option value="Contratista">Contratista</option>
                        <option value="Proveedor">Proveedor</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Tel√©fono de Contacto</label>
                    <input type="tel" id="telefonoAfectado">
                </div>
            </div>
            
            <h2 class="section-title">üí• Severidad del Accidente</h2>
            
            <div class="severity-selector">
                <div class="severity-option leve" onclick="seleccionarSeveridad('leve')">
                    <div style="font-size: 2em; margin-bottom: 10px;">üòä</div>
                    <strong>LEVE</strong>
                    <p style="font-size: 0.85em; margin-top: 5px;">Sin lesiones o lesiones menores</p>
                </div>
                <div class="severity-option grave" onclick="seleccionarSeveridad('grave')">
                    <div style="font-size: 2em; margin-bottom: 10px;">üò∞</div>
                    <strong>GRAVE</strong>
                    <p style="font-size: 0.85em; margin-top: 5px;">Lesiones que requieren atenci√≥n m√©dica</p>
                </div>
                <div class="severity-option fatal" onclick="seleccionarSeveridad('fatal')">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚ò†Ô∏è</div>
                    <strong>FATAL</strong>
                    <p style="font-size: 0.85em; margin-top: 5px;">Riesgo de vida o muerte</p>
                </div>
            </div>
            <input type="hidden" id="severidad">
            
            <h2 class="section-title">üìù Descripci√≥n del Evento</h2>
            
            <div class="form-group">
                <label>¬øQu√© sucedi√≥? (Descripci√≥n detallada) <span class="required">*</span></label>
                <textarea id="descripcionEvento" placeholder="Describa exactamente qu√© sucedi√≥, c√≥mo ocurri√≥ el accidente, condiciones del momento, etc." required></textarea>
            </div>
            
            <div class="form-group">
                <label>Lesiones o Da√±os Reportados</label>
                <textarea id="lesiones" placeholder="Describa las lesiones sufridas o da√±os materiales"></textarea>
            </div>
            
            <div class="form-group">
                <label>Primeros Auxilios Prestados</label>
                <textarea id="primerosAuxilios" placeholder="¬øQu√© atenci√≥n inmediata se brind√≥? ¬øQui√©n la prest√≥?"></textarea>
            </div>
            
            <h2 class="section-title">üîç Causas Identificadas</h2>
            
            <div class="form-group">
                <label>Causas Inmediatas (acciones/condiciones inseguras)</label>
                <textarea id="causasInmediatas" placeholder="Ej: Piso mojado, falta de se√±alizaci√≥n, acci√≥n insegura del trabajador"></textarea>
            </div>
            
            <div class="form-group">
                <label>Causas B√°sicas (factores personales/organizacionales)</label>
                <textarea id="causasBasicas" placeholder="Ej: Falta de capacitaci√≥n, mantenimiento deficiente, supervisi√≥n inadecuada"></textarea>
            </div>
            
            <h2 class="section-title">‚úÖ Acciones Correctivas y Preventivas</h2>
            
            <div class="form-group">
                <label>Acciones Inmediatas Tomadas <span class="required">*</span></label>
                <textarea id="accionesInmediatas" placeholder="¬øQu√© se hizo inmediatamente despu√©s del accidente?" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Acciones Preventivas a Implementar</label>
                <textarea id="accionesPreventivas" placeholder="¬øQu√© se va a hacer para evitar que vuelva a ocurrir?"></textarea>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Responsable del Seguimiento</label>
                    <input type="text" id="responsableSeguimiento" value="Carla Castellano Madriz">
                </div>
                
                <div class="form-group">
                    <label>Fecha L√≠mite para Acciones</label>
                    <input type="date" id="fechaLimite">
                </div>
            </div>
            
            <div class="form-group">
                <label>Testigos del Evento</label>
                <textarea id="testigos" placeholder="Nombre y contacto de testigos presenciales"></textarea>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-primary" onclick="guardarAccidente()">
                üíæ Guardar Investigaci√≥n
            </button>
            <button class="btn btn-success" onclick="verHistorial()">
                üìä Ver Historial de Accidentes
            </button>
            <button class="btn btn-secondary" onclick="limpiarFormulario()">
                üîÑ Nuevo Registro
            </button>
        </div>
        
        <div class="accidentes-list" id="historialSection" style="display: none;">
            <h2 class="section-title">üìä Historial de Accidentes e Incidentes</h2>
            
            <div class="stats-container" id="statsContainer">
                <!-- Estad√≠sticas se cargar√°n aqu√≠ -->
            </div>
            
            <div id="listaAccidentes">
                <!-- Lista de accidentes se cargar√° aqu√≠ -->
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCb2pko11_UOP6V5VPQV_xARWrC5wybQ6w",
            authDomain: "compliancepro--o--sistemass.firebaseapp.com",
            databaseURL: "https://compliancepro--o--sistemass-default-rtdb.firebaseio.com",
            projectId: "compliancepro--o--sistemass",
            storageBucket: "compliancepro--o--sistemass.firebasestorage.app",
            messagingSenderId: "188559834704",
            appId: "1:188559834704:web:73f1b088e9dcda16ab9b55"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const EDIFICIO_ID = 'nepal-2';

        console.log('‚úÖ Firebase inicializado - Investigaci√≥n Accidentes Nepal 2');

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        let severidadSeleccionada = '';
        
        function seleccionarSeveridad(severidad) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.severity-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nueva opci√≥n
            event.currentTarget.classList.add('selected');
            severidadSeleccionada = severidad;
            document.getElementById('severidad').value = severidad;
        }
        
        function guardarAccidente() {
            // Validar campos requeridos
            const fechaAccidente = document.getElementById('fechaAccidente').value;
            const horaAccidente = document.getElementById('horaAccidente').value;
            const lugar = document.getElementById('lugar').value;
            const tipoEvento = document.getElementById('tipoEvento').value;
            const nombreAfectado = document.getElementById('nombreAfectado').value;
            const cargoAfectado = document.getElementById('cargoAfectado').value;
            const descripcionEvento = document.getElementById('descripcionEvento').value;
            const accionesInmediatas = document.getElementById('accionesInmediatas').value;
            
            if (!fechaAccidente || !horaAccidente || !lugar || !tipoEvento || !nombreAfectado || 
                !cargoAfectado || !descripcionEvento || !accionesInmediatas || !severidadSeleccionada) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios (*)');
                return;
            }
            
            // Crear objeto del accidente
            const accidente = {
                timestamp: new Date().toISOString(),
                fechaAccidente: fechaAccidente,
                horaAccidente: horaAccidente,
                lugar: lugar,
                tipoEvento: tipoEvento,
                nombreAfectado: nombreAfectado,
                documentoAfectado: document.getElementById('documentoAfectado').value,
                cargoAfectado: cargoAfectado,
                telefonoAfectado: document.getElementById('telefonoAfectado').value,
                severidad: severidadSeleccionada,
                descripcionEvento: descripcionEvento,
                lesiones: document.getElementById('lesiones').value,
                primerosAuxilios: document.getElementById('primerosAuxilios').value,
                causasInmediatas: document.getElementById('causasInmediatas').value,
                causasBasicas: document.getElementById('causasBasicas').value,
                accionesInmediatas: accionesInmediatas,
                accionesPreventivas: document.getElementById('accionesPreventivas').value,
                responsableSeguimiento: document.getElementById('responsableSeguimiento').value,
                fechaLimite: document.getElementById('fechaLimite').value,
                testigos: document.getElementById('testigos').value,
                mes: new Date(fechaAccidente).getMonth(),
                a√±o: new Date(fechaAccidente).getFullYear()
            };
            
            // Guardar en Firebase
            const nuevoAccidenteRef = database.ref(`edificios/${EDIFICIO_ID}/accidentes`).push();
            
            nuevoAccidenteRef.set(accidente)
                .then(() => {
                    alert('‚úÖ Investigaci√≥n de accidente guardada exitosamente en Firebase');
                    console.log('‚úÖ Accidente guardado:', accidente);
                    limpiarFormulario();
                })
                .catch((error) => {
                    console.error('‚ùå Error guardando accidente:', error);
                    alert('‚ùå Error al guardar: ' + error.message);
                });
        }
        
        function limpiarFormulario() {
            document.getElementById('fechaAccidente').value = '';
            document.getElementById('horaAccidente').value = '';
            document.getElementById('lugar').value = '';
            document.getElementById('tipoEvento').value = '';
            document.getElementById('nombreAfectado').value = '';
            document.getElementById('documentoAfectado').value = '';
            document.getElementById('cargoAfectado').value = '';
            document.getElementById('telefonoAfectado').value = '';
            document.getElementById('descripcionEvento').value = '';
            document.getElementById('lesiones').value = '';
            document.getElementById('primerosAuxilios').value = '';
            document.getElementById('causasInmediatas').value = '';
            document.getElementById('causasBasicas').value = '';
            document.getElementById('accionesInmediatas').value = '';
            document.getElementById('accionesPreventivas').value = '';
            document.getElementById('responsableSeguimiento').value = 'Carla Castellano Madriz';
            document.getElementById('fechaLimite').value = '';
            document.getElementById('testigos').value = '';
            
            // Limpiar selecci√≥n de severidad
            document.querySelectorAll('.severity-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            severidadSeleccionada = '';
            
            // Ocultar historial
            document.getElementById('historialSection').style.display = 'none';
        }
        
        async function verHistorial() {
            const historialSection = document.getElementById('historialSection');
            historialSection.style.display = 'block';
            historialSection.scrollIntoView({ behavior: 'smooth' });
            
            try {
                const snapshot = await database.ref(`edificios/${EDIFICIO_ID}/accidentes`).once('value');
                const accidentes = [];
                
                snapshot.forEach((childSnapshot) => {
                    accidentes.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Ordenar por fecha m√°s reciente
                accidentes.sort((a, b) => new Date(b.fechaAccidente) - new Date(a.fechaAccidente));
                
                // Mostrar estad√≠sticas
                mostrarEstadisticas(accidentes);
                
                // Mostrar lista de accidentes
                const listaDiv = document.getElementById('listaAccidentes');
                
                if (accidentes.length === 0) {
                    listaDiv.innerHTML = `
                        <div class="no-accidentes">
                            <div class="icon">‚úÖ</div>
                            <h3>No hay accidentes registrados</h3>
                            <p>¬°Excelente! No se han reportado accidentes en este edificio.</p>
                        </div>
                    `;
                } else {
                    listaDiv.innerHTML = accidentes.map(acc => `
                        <div class="accidente-card">
                            <div class="accidente-header">
                                <div class="accidente-fecha">
                                    üìÖ ${formatearFecha(acc.fechaAccidente)} - ${acc.horaAccidente}
                                </div>
                                <div class="severity-badge ${acc.severidad}">
                                    ${acc.severidad.toUpperCase()}
                                </div>
                            </div>
                            
                            <div class="accidente-info">
                                <div class="info-item">
                                    <strong>Tipo:</strong> ${acc.tipoEvento}
                                </div>
                                <div class="info-item">
                                    <strong>Lugar:</strong> ${acc.lugar}
                                </div>
                                <div class="info-item">
                                    <strong>Persona Afectada:</strong> ${acc.nombreAfectado}
                                </div>
                                <div class="info-item">
                                    <strong>Cargo:</strong> ${acc.cargoAfectado}
                                </div>
                            </div>
                            
                            <div class="accidente-descripcion">
                                <strong>Descripci√≥n del Evento:</strong>
                                <p style="margin-top: 10px;">${acc.descripcionEvento}</p>
                            </div>
                            
                            ${acc.lesiones ? `
                                <div class="accidente-descripcion" style="margin-top: 15px;">
                                    <strong>Lesiones:</strong>
                                    <p style="margin-top: 10px;">${acc.lesiones}</p>
                                </div>
                            ` : ''}
                            
                            ${acc.accionesPreventivas ? `
                                <div class="accidente-descripcion" style="margin-top: 15px;">
                                    <strong>Acciones Preventivas:</strong>
                                    <p style="margin-top: 10px;">${acc.accionesPreventivas}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                alert('‚ùå Error cargando historial: ' + error.message);
            }
        }
        
        function mostrarEstadisticas(accidentes) {
            const stats = {
                total: accidentes.length,
                leves: accidentes.filter(a => a.severidad === 'leve').length,
                graves: accidentes.filter(a => a.severidad === 'grave').length,
                fatales: accidentes.filter(a => a.severidad === 'fatal').length,
                esteA√±o: accidentes.filter(a => a.a√±o === new Date().getFullYear()).length
            };
            
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Registrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.esteA√±o}</div>
                    <div class="stat-label">Este A√±o (${new Date().getFullYear()})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #4caf50;">${stats.leves}</div>
                    <div class="stat-label">Leves</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ff9800;">${stats.graves}</div>
                    <div class="stat-label">Graves</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #f44336;">${stats.fatales}</div>
                    <div class="stat-label">Fatales</div>
                </div>
            `;
        }
        
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-CO', opciones);
        }
        
        // Establecer fecha y hora actual por defecto
        const hoy = new Date();
        document.getElementById('fechaAccidente').valueAsDate = hoy;
        document.getElementById('horaAccidente').value = hoy.toTimeString().slice(0,5);
    </script>
</body>
</html>