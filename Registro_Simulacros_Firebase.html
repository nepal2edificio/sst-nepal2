<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Simulacros - Nepal 2</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-section {
            padding: 40px;
        }
        
        .section-title {
            color: #d32f2f;
            font-size: 1.6em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #d32f2f;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #d32f2f;
            font-size: 1.05em;
        }
        
        .required {
            color: #f44336;
        }
        
        input, select, textarea {
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f44336;
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .alert-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .alert-box h4 {
            color: #c62828;
            margin-bottom: 10px;
        }
        
        .tipo-simulacro {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .tipo-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tipo-option:hover {
            border-color: #f44336;
            transform: translateY(-2px);
        }
        
        .tipo-option.selected {
            border-color: #d32f2f;
            background: #ffebee;
        }
        
        .tipo-option .icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .participants-counter {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .counter-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #d32f2f;
            background: white;
            color: #d32f2f;
            border-radius: 8px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .counter-btn:hover {
            background: #d32f2f;
            color: white;
        }
        
        .counter-display {
            font-size: 2.5em;
            font-weight: 700;
            color: #d32f2f;
            min-width: 80px;
            text-align: center;
        }
        
        .checklist-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checklist-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .checklist-item label {
            cursor: pointer;
            flex: 1;
            color: #333;
            font-weight: normal;
        }
        
        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .simulacros-list {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .simulacro-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #d32f2f;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .simulacro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .simulacro-fecha {
            font-weight: 700;
            color: #d32f2f;
            font-size: 1.2em;
        }
        
        .resultado-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .resultado-badge.exitoso {
            background: #d4edda;
            color: #155724;
        }
        
        .resultado-badge.mejorable {
            background: #fff3cd;
            color: #856404;
        }
        
        .resultado-badge.deficiente {
            background: #f8d7da;
            color: #721c24;
        }
        
        .simulacro-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-item strong {
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .no-simulacros {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-simulacros .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 3em;
            font-weight: 700;
            color: #d32f2f;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95em;
        }
        
        .tiempo-display {
            font-size: 1.2em;
            font-weight: 600;
            color: #d32f2f;
            text-align: center;
            padding: 10px;
            background: #ffebee;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Registro de Simulacros de Emergencia</h1>
            <p>Edificio Nepal 2 - Plan de Preparaci√≥n y Respuesta</p>
        </div>
        
        <div class="form-section">
            <div class="alert-box">
                <h4>üìã Normativa</h4>
                <p>Seg√∫n la Resoluci√≥n 0312/2019, las empresas deben realizar m√≠nimo 1 simulacro al a√±o. Se recomienda realizar simulacros cada 6 meses para mantener la preparaci√≥n del personal.</p>
            </div>
            
            <h2 class="section-title">üìÖ Informaci√≥n del Simulacro</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Fecha del Simulacro <span class="required">*</span></label>
                    <input type="date" id="fechaSimulacro" required>
                </div>
                
                <div class="form-group">
                    <label>Hora de Inicio <span class="required">*</span></label>
                    <input type="time" id="horaInicio" required>
                </div>
                
                <div class="form-group">
                    <label>Hora de Finalizaci√≥n <span class="required">*</span></label>
                    <input type="time" id="horaFin" required>
                </div>
                
                <div class="form-group">
                    <label>Duraci√≥n Total</label>
                    <div class="tiempo-display" id="duracionDisplay">00:00 minutos</div>
                </div>
            </div>
            
            <h2 class="section-title">üî• Tipo de Simulacro</h2>
            
            <div class="tipo-simulacro">
                <div class="tipo-option" onclick="seleccionarTipo('incendio')">
                    <div class="icon">üî•</div>
                    <strong>Incendio</strong>
                </div>
                <div class="tipo-option" onclick="seleccionarTipo('sismo')">
                    <div class="icon">üåç</div>
                    <strong>Sismo</strong>
                </div>
                <div class="tipo-option" onclick="seleccionarTipo('evacuacion')">
                    <div class="icon">üö™</div>
                    <strong>Evacuaci√≥n</strong>
                </div>
                <div class="tipo-option" onclick="seleccionarTipo('amenaxa-bomba')">
                    <div class="icon">üí£</div>
                    <strong>Amenaza</strong>
                </div>
                <div class="tipo-option" onclick="seleccionarTipo('primeros-auxilios')">
                    <div class="icon">‚öïÔ∏è</div>
                    <strong>Primeros Auxilios</strong>
                </div>
                <div class="tipo-option" onclick="seleccionarTipo('otro')">
                    <div class="icon">üìã</div>
                    <strong>Otro</strong>
                </div>
            </div>
            <input type="hidden" id="tipoSimulacro">
            
            <h2 class="section-title">üë• Participaci√≥n</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>N√∫mero de Participantes <span class="required">*</span></label>
                    <div class="participants-counter">
                        <button type="button" class="counter-btn" onclick="cambiarParticipantes(-1)">‚àí</button>
                        <div class="counter-display" id="participantesDisplay">0</div>
                        <button type="button" class="counter-btn" onclick="cambiarParticipantes(1)">+</button>
                    </div>
                    <input type="hidden" id="participantes" value="0">
                </div>
                
                <div class="form-group">
                    <label>Total de Ocupantes del Edificio</label>
                    <input type="number" id="totalOcupantes" placeholder="Ej: 50">
                </div>
            </div>
            
            <div class="form-group">
                <label>Coordinador del Simulacro <span class="required">*</span></label>
                <input type="text" id="coordinador" value="Carla Castellano Madriz" required>
            </div>
            
            <div class="form-group">
                <label>Observadores Externos (opcional)</label>
                <input type="text" id="observadores" placeholder="Ej: Bomberos, ARL, Defensa Civil">
            </div>
            
            <h2 class="section-title">‚úÖ Lista de Verificaci√≥n del Simulacro</h2>
            
            <div class="checklist-section">
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check1">
                    <label for="check1">Se activ√≥ la alarma de emergencia correctamente</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check2">
                    <label for="check2">Las rutas de evacuaci√≥n estaban despejadas</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check3">
                    <label for="check3">Las salidas de emergencia funcionaron correctamente</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check4">
                    <label for="check4">La iluminaci√≥n de emergencia funcion√≥</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check5">
                    <label for="check5">La brigada de emergencia actu√≥ seg√∫n el protocolo</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check6">
                    <label for="check6">Se realiz√≥ conteo de personas en punto de encuentro</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check7">
                    <label for="check7">Se comunic√≥ el fin del simulacro adecuadamente</label>
                </div>
                <div class="checklist-item" onclick="toggleCheck(this)">
                    <input type="checkbox" id="check8">
                    <label for="check8">El tiempo de evacuaci√≥n fue adecuado</label>
                </div>
            </div>
            
            <h2 class="section-title">üìä Evaluaci√≥n del Simulacro</h2>
            
            <div class="form-group">
                <label>Resultado General <span class="required">*</span></label>
                <select id="resultadoGeneral" required>
                    <option value="">Seleccionar...</option>
                    <option value="exitoso">Exitoso - Cumpli√≥ todos los objetivos</option>
                    <option value="mejorable">Mejorable - Cumpli√≥ parcialmente</option>
                    <option value="deficiente">Deficiente - No cumpli√≥ objetivos</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Aspectos Positivos Observados <span class="required">*</span></label>
                <textarea id="aspectosPositivos" placeholder="¬øQu√© funcion√≥ bien durante el simulacro?" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Aspectos a Mejorar <span class="required">*</span></label>
                <textarea id="aspectosMejorar" placeholder="¬øQu√© se debe mejorar para el pr√≥ximo simulacro?" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Hallazgos Cr√≠ticos o Incidentes</label>
                <textarea id="hallazgosCriticos" placeholder="Problemas graves detectados durante el simulacro"></textarea>
            </div>
            
            <div class="form-group">
                <label>Plan de Acci√≥n / Acciones Correctivas</label>
                <textarea id="planAccion" placeholder="¬øQu√© acciones se tomar√°n para mejorar?"></textarea>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Responsable del Seguimiento</label>
                    <input type="text" id="responsableSeguimiento" value="Carla Castellano Madriz">
                </div>
                
                <div class="form-group">
                    <label>Fecha Pr√≥ximo Simulacro</label>
                    <input type="date" id="fechaProximo">
                </div>
            </div>
            
            <div class="form-group">
                <label>Observaciones Adicionales</label>
                <textarea id="observaciones" placeholder="Cualquier otra informaci√≥n relevante del simulacro"></textarea>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-primary" onclick="guardarSimulacro()">
                üíæ Guardar Simulacro
            </button>
            <button class="btn btn-success" onclick="verHistorial()">
                üìä Ver Historial de Simulacros
            </button>
            <button class="btn btn-secondary" onclick="limpiarFormulario()">
                üîÑ Nuevo Registro
            </button>
        </div>
        
        <div class="simulacros-list" id="historialSection" style="display: none;">
            <h2 class="section-title">üìä Historial de Simulacros</h2>
            
            <div class="stats-container" id="statsContainer">
                <!-- Estad√≠sticas se cargar√°n aqu√≠ -->
            </div>
            
            <div id="listaSimulacros">
                <!-- Lista de simulacros se cargar√° aqu√≠ -->
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCb2pko11_UOP6V5VPQV_xARWrC5wybQ6w",
            authDomain: "compliancepro--o--sistemass.firebaseapp.com",
            databaseURL: "https://compliancepro--o--sistemass-default-rtdb.firebaseio.com",
            projectId: "compliancepro--o--sistemass",
            storageBucket: "compliancepro--o--sistemass.firebasestorage.app",
            messagingSenderId: "188559834704",
            appId: "1:188559834704:web:73f1b088e9dcda16ab9b55"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const EDIFICIO_ID = 'nepal-2';

        console.log('‚úÖ Firebase inicializado - Registro Simulacros Nepal 2');

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        let tipoSeleccionado = '';
        let participantesCount = 0;
        
        function seleccionarTipo(tipo) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.tipo-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nueva opci√≥n
            event.currentTarget.classList.add('selected');
            tipoSeleccionado = tipo;
            document.getElementById('tipoSimulacro').value = tipo;
        }
        
        function cambiarParticipantes(cambio) {
            participantesCount = Math.max(0, participantesCount + cambio);
            document.getElementById('participantesDisplay').textContent = participantesCount;
            document.getElementById('participantes').value = participantesCount;
        }
        
        function toggleCheck(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
        }
        
        function calcularDuracion() {
            const horaInicio = document.getElementById('horaInicio').value;
            const horaFin = document.getElementById('horaFin').value;
            
            if (horaInicio && horaFin) {
                const [hi, mi] = horaInicio.split(':').map(Number);
                const [hf, mf] = horaFin.split(':').map(Number);
                
                const inicio = hi * 60 + mi;
                const fin = hf * 60 + mf;
                const duracion = fin - inicio;
                
                if (duracion > 0) {
                    const horas = Math.floor(duracion / 60);
                    const minutos = duracion % 60;
                    const texto = horas > 0 ? `${horas}h ${minutos}min` : `${minutos} minutos`;
                    document.getElementById('duracionDisplay').textContent = texto;
                    return duracion;
                }
            }
            document.getElementById('duracionDisplay').textContent = '00:00 minutos';
            return 0;
        }
        
        document.getElementById('horaInicio').addEventListener('change', calcularDuracion);
        document.getElementById('horaFin').addEventListener('change', calcularDuracion);
        
        function getChecklistStatus() {
            const checks = [];
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`check${i}`);
                checks.push({
                    item: checkbox.nextElementSibling.textContent,
                    cumple: checkbox.checked
                });
            }
            return checks;
        }
        
        function guardarSimulacro() {
            // Validar campos requeridos
            const fechaSimulacro = document.getElementById('fechaSimulacro').value;
            const horaInicio = document.getElementById('horaInicio').value;
            const horaFin = document.getElementById('horaFin').value;
            const coordinador = document.getElementById('coordinador').value;
            const resultadoGeneral = document.getElementById('resultadoGeneral').value;
            const aspectosPositivos = document.getElementById('aspectosPositivos').value;
            const aspectosMejorar = document.getElementById('aspectosMejorar').value;
            
            if (!fechaSimulacro || !horaInicio || !horaFin || !tipoSeleccionado || 
                participantesCount === 0 || !coordinador || !resultadoGeneral || 
                !aspectosPositivos || !aspectosMejorar) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios (*)');
                return;
            }
            
            const duracion = calcularDuracion();
            
            // Crear objeto del simulacro
            const simulacro = {
                timestamp: new Date().toISOString(),
                fechaSimulacro: fechaSimulacro,
                horaInicio: horaInicio,
                horaFin: horaFin,
                duracionMinutos: duracion,
                tipoSimulacro: tipoSeleccionado,
                participantes: participantesCount,
                totalOcupantes: document.getElementById('totalOcupantes').value,
                coordinador: coordinador,
                observadores: document.getElementById('observadores').value,
                checklist: getChecklistStatus(),
                resultadoGeneral: resultadoGeneral,
                aspectosPositivos: aspectosPositivos,
                aspectosMejorar: aspectosMejorar,
                hallazgosCriticos: document.getElementById('hallazgosCriticos').value,
                planAccion: document.getElementById('planAccion').value,
                responsableSeguimiento: document.getElementById('responsableSeguimiento').value,
                fechaProximo: document.getElementById('fechaProximo').value,
                observaciones: document.getElementById('observaciones').value,
                mes: new Date(fechaSimulacro).getMonth(),
                a√±o: new Date(fechaSimulacro).getFullYear()
            };
            
            // Guardar en Firebase
            const nuevoSimulacroRef = database.ref(`edificios/${EDIFICIO_ID}/simulacros`).push();
            
            nuevoSimulacroRef.set(simulacro)
                .then(() => {
                    alert('‚úÖ Simulacro guardado exitosamente en Firebase');
                    console.log('‚úÖ Simulacro guardado:', simulacro);
                    limpiarFormulario();
                })
                .catch((error) => {
                    console.error('‚ùå Error guardando simulacro:', error);
                    alert('‚ùå Error al guardar: ' + error.message);
                });
        }
        
        function limpiarFormulario() {
            document.getElementById('fechaSimulacro').value = '';
            document.getElementById('horaInicio').value = '';
            document.getElementById('horaFin').value = '';
            document.getElementById('totalOcupantes').value = '';
            document.getElementById('coordinador').value = 'Carla Castellano Madriz';
            document.getElementById('observadores').value = '';
            document.getElementById('resultadoGeneral').value = '';
            document.getElementById('aspectosPositivos').value = '';
            document.getElementById('aspectosMejorar').value = '';
            document.getElementById('hallazgosCriticos').value = '';
            document.getElementById('planAccion').value = '';
            document.getElementById('responsableSeguimiento').value = 'Carla Castellano Madriz';
            document.getElementById('fechaProximo').value = '';
            document.getElementById('observaciones').value = '';
            
            // Limpiar tipo seleccionado
            document.querySelectorAll('.tipo-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            tipoSeleccionado = '';
            
            // Resetear participantes
            participantesCount = 0;
            document.getElementById('participantesDisplay').textContent = '0';
            document.getElementById('participantes').value = '0';
            
            // Limpiar checklist
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`check${i}`).checked = false;
            }
            
            // Limpiar duraci√≥n
            document.getElementById('duracionDisplay').textContent = '00:00 minutos';
            
            // Ocultar historial
            document.getElementById('historialSection').style.display = 'none';
        }
        
        async function verHistorial() {
            const historialSection = document.getElementById('historialSection');
            historialSection.style.display = 'block';
            historialSection.scrollIntoView({ behavior: 'smooth' });
            
            try {
                const snapshot = await database.ref(`edificios/${EDIFICIO_ID}/simulacros`).once('value');
                const simulacros = [];
                
                snapshot.forEach((childSnapshot) => {
                    simulacros.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Ordenar por fecha m√°s reciente
                simulacros.sort((a, b) => new Date(b.fechaSimulacro) - new Date(a.fechaSimulacro));
                
                // Mostrar estad√≠sticas
                mostrarEstadisticas(simulacros);
                
                // Mostrar lista de simulacros
                const listaDiv = document.getElementById('listaSimulacros');
                
                if (simulacros.length === 0) {
                    listaDiv.innerHTML = `
                        <div class="no-simulacros">
                            <div class="icon">üìã</div>
                            <h3>No hay simulacros registrados</h3>
                            <p>A√∫n no se han realizado simulacros de emergencia en este edificio.</p>
                        </div>
                    `;
                } else {
                    listaDiv.innerHTML = simulacros.map(sim => {
                        const checksCumplidos = sim.checklist ? sim.checklist.filter(c => c.cumple).length : 0;
                        const totalChecks = sim.checklist ? sim.checklist.length : 0;
                        const porcentajeCumplimiento = totalChecks > 0 ? Math.round((checksCumplidos / totalChecks) * 100) : 0;
                        
                        return `
                        <div class="simulacro-card">
                            <div class="simulacro-header">
                                <div class="simulacro-fecha">
                                    üìÖ ${formatearFecha(sim.fechaSimulacro)}
                                </div>
                                <div class="resultado-badge ${sim.resultadoGeneral}">
                                    ${sim.resultadoGeneral.toUpperCase()}
                                </div>
                            </div>
                            
                            <div class="simulacro-info">
                                <div class="info-item">
                                    <strong>Tipo:</strong> ${getTipoIcon(sim.tipoSimulacro)} ${formatearTipo(sim.tipoSimulacro)}
                                </div>
                                <div class="info-item">
                                    <strong>Duraci√≥n:</strong> ${sim.duracionMinutos} minutos
                                </div>
                                <div class="info-item">
                                    <strong>Participantes:</strong> ${sim.participantes} personas
                                </div>
                                <div class="info-item">
                                    <strong>Cumplimiento:</strong> ${porcentajeCumplimiento}% (${checksCumplidos}/${totalChecks})
                                </div>
                                <div class="info-item">
                                    <strong>Coordinador:</strong> ${sim.coordinador}
                                </div>
                                <div class="info-item">
                                    <strong>Hora:</strong> ${sim.horaInicio} - ${sim.horaFin}
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong style="color: #059669;">‚úÖ Aspectos Positivos:</strong>
                                <p style="margin-top: 10px;">${sim.aspectosPositivos}</p>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong style="color: #856404;">‚ö†Ô∏è Aspectos a Mejorar:</strong>
                                <p style="margin-top: 10px;">${sim.aspectosMejorar}</p>
                            </div>
                            
                            ${sim.planAccion ? `
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                    <strong style="color: #1976d2;">üìã Plan de Acci√≥n:</strong>
                                    <p style="margin-top: 10px;">${sim.planAccion}</p>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                alert('‚ùå Error cargando historial: ' + error.message);
            }
        }
        
        function mostrarEstadisticas(simulacros) {
            const a√±oActual = new Date().getFullYear();
            const stats = {
                total: simulacros.length,
                esteA√±o: simulacros.filter(s => s.a√±o === a√±oActual).length,
                exitosos: simulacros.filter(s => s.resultadoGeneral === 'exitoso').length,
                participacionPromedio: simulacros.length > 0 ? 
                    Math.round(simulacros.reduce((sum, s) => sum + (parseInt(s.participantes) || 0), 0) / simulacros.length) : 0,
                ultimoSimulacro: simulacros.length > 0 ? simulacros[0].fechaSimulacro : 'N/A'
            };
            
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Simulacros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.esteA√±o}</div>
                    <div class="stat-label">Este A√±o (${a√±oActual})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #10b981;">${stats.exitosos}</div>
                    <div class="stat-label">Exitosos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.participacionPromedio}</div>
                    <div class="stat-label">Participaci√≥n Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="font-size: 1.2em;">
                        ${stats.ultimoSimulacro !== 'N/A' ? formatearFechaCorta(stats.ultimoSimulacro) : 'N/A'}
                    </div>
                    <div class="stat-label">√öltimo Simulacro</div>
                </div>
            `;
        }
        
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-CO', opciones);
        }
        
        function formatearFechaCorta(fecha) {
            const opciones = { month: 'short', day: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-CO', opciones);
        }
        
        function formatearTipo(tipo) {
            const tipos = {
                'incendio': 'Incendio',
                'sismo': 'Sismo',
                'evacuacion': 'Evacuaci√≥n',
                'amenaxa-bomba': 'Amenaza de Bomba',
                'primeros-auxilios': 'Primeros Auxilios',
                'otro': 'Otro'
            };
            return tipos[tipo] || tipo;
        }
        
        function getTipoIcon(tipo) {
            const iconos = {
                'incendio': 'üî•',
                'sismo': 'üåç',
                'evacuacion': 'üö™',
                'amenaxa-bomba': 'üí£',
                'primeros-auxilios': '‚öïÔ∏è',
                'otro': 'üìã'
            };
            return iconos[tipo] || 'üìã';
        }
        
        // Establecer fecha actual por defecto
        document.getElementById('fechaSimulacro').valueAsDate = new Date();
    </script>
</body>
</html>